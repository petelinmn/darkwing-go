stages:
  - build
  - deploy

variables:
  DOCKER_TLS_CERTDIR: "" # Required for docker:dind on GitLab SaaS
  DOCKER_HOST: tcp://docker:2375
  DOCKER_DRIVER: overlay2
  # Push to GHCR (GitHub Container Registry) to match k8s manifests
  GHCR_REGISTRY: ghcr.io
  GHCR_IMAGE_PREFIX: ghcr.io/petelinmn/darkwing-go

############################
# Scope dind to build jobs #
############################

build_api:
  stage: build
  image: docker:25.0.3
  services:
    - name: docker:25.0.3-dind
      command: ["--mtu=1460"]
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
  script:
    - docker info
    - |
      AUTH=$(printf "petelinmn:%s" "$GHCR_TOKEN" | base64 | tr -d '\n')
      export DOCKER_AUTH_CONFIG="{\"auths\":{\"ghcr.io\":{\"auth\":\"$AUTH\"}}}"
    - docker build -f api/Dockerfile -t "$GHCR_IMAGE_PREFIX/api:latest" -t "$GHCR_IMAGE_PREFIX/api:sha-$CI_COMMIT_SHA" .
    - docker push "$GHCR_IMAGE_PREFIX/api:latest"
    - docker push "$GHCR_IMAGE_PREFIX/api:sha-$CI_COMMIT_SHA"

build_worker:
  stage: build
  image: docker:25.0.3
  services:
    - name: docker:25.0.3-dind
      command: ["--mtu=1460"]
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
  script:
    - docker info
    - |
      AUTH=$(printf "petelinmn:%s" "$GHCR_TOKEN" | base64 | tr -d '\n')
      export DOCKER_AUTH_CONFIG="{\"auths\":{\"ghcr.io\":{\"auth\":\"$AUTH\"}}}"
    - docker build -f worker/Dockerfile -t "$GHCR_IMAGE_PREFIX/worker:latest" -t "$GHCR_IMAGE_PREFIX/worker:sha-$CI_COMMIT_SHA" .
    - docker push "$GHCR_IMAGE_PREFIX/worker:latest"
    - docker push "$GHCR_IMAGE_PREFIX/worker:sha-$CI_COMMIT_SHA"

deploy:
  stage: deploy
  image: lachlanevenson/k8s-kubectl:v1.30.4
  needs: ["build_api", "build_worker"]
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
  before_script:
    - mkdir -p ~/.kube
    - |
      if [ -n "$KUBECONFIG" ]; then
        cp "$KUBECONFIG" ~/.kube/config
      else
        echo "$KUBECONFIGCONTENT" > ~/.kube/config
      fi
    - chmod 600 ~/.kube/config
  script:
    - kubectl apply -f k8s/namespace.yaml
    - kubectl apply -f k8s/api-deployment.yaml
    - kubectl apply -f k8s/api-service.yaml
    - kubectl apply -f k8s/worker-deployment.yaml
    - kubectl -n darkwing set image deployment/api api="$GHCR_IMAGE_PREFIX/api:sha-$CI_COMMIT_SHA"
    - kubectl -n darkwing set image deployment/worker worker="$GHCR_IMAGE_PREFIX/worker:sha-$CI_COMMIT_SHA"
    - kubectl -n darkwing get deploy,rs,pods -o wide
    - kubectl -n darkwing get svc api
